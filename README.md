# foc
Two motor 48V 20+20A FOC controller for sim racing seatbelt tensioner

### Motor Selection
First, the correct motor type was selected based on requirements

While exhibiting drawbacks like cogging torque, BLDC PSMS was chosen for backdrivability and torque control. Specifically, the 48V model is chosen because of the lack of 220V main power in the room of operation.

Then correct torque and integrated sensors (Hall effect per phase and absolute encoder)

These are critical to this project because it involves operating the motor at low speeds and often from standstill, which the sensors improve the quality of the torque control.

After a great long search, a well priced high power model was found on AliBaba. Now all that remained was a way to control this motor.

### Controller Build
The quest to develop a reasonably priced 2 channel 48V 40A FOC controller

I looked into existing solutions but found them to be too expensive, so I set out to make my own.

I learned a lot about Field oriented control and BLDC phases.

#### Controller Design Choices
- MCU: STMF405VGT, chosen for compatibilty with VESC firmware and high GPIO count, ADC for current sense
- Motor driver: 2x DRV8323S, no internal buck. High power LDO and additonal low noise LDO both already implemented. DRV8323S compatible with VESC via SPI, and internal current sense amplifiers
- MOFSET: 12x CSD19536KCS, high voltage, low RDS on, big thermally conductive package. Two for each phase: 2x3x2
- 6x Shunt resistors: Opting for higher quality control for the basis of FOC control: torque control by current measurement. One for each phase instead of Kirchoff's rule estimation for last one. In lower rpm scenarios like this one, two would be a noticable downgrade.
- Connections: USART, SWD, and USB all made avaliable and connected for debugging

Thus the following rough prototype was made:

<img width="377" alt="image" src="https://github.com/user-attachments/assets/0158843e-783a-4e0b-9bb7-46b238e166f8" />

![image](https://github.com/user-attachments/assets/02b2ee7c-641c-4e55-943c-85cce2903060)

Then, when I caclulated this in a few PCB manufactures, the cost was far more than just a prebuilt.
Parts alone rivaled prebuilt solutions on Alibaba, and the heavier copper layers and PCBA brought it to wild levels.

Unfourtanly, this meant I would have to opt for a prebuilt solution.

### Controller Selection

Of the existing solutions, the Odrive 3.6 stood out for meeting the requirements. Others like ODESC 3.6 lack three shunt resistors.

This is also avaliable on Alibaba for far less than any other controller of its class.

### Case Design

While robust and powerful, these motors are not designed to withstand axial force (like that generated by the seatbelt resistance). In order to midigate this wear on the motors, and to mount them to the rig in the first place, a appropriate casing was designed.
